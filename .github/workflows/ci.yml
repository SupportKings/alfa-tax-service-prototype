name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUN_VERSION: "latest"
  NODE_OPTIONS: "--max-old-space-size=4096"
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.filter.outputs.web }}
      server: ${{ steps.filter.outputs.server }}
      e2e: ${{ steps.filter.outputs.e2e }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            web:
              - 'apps/web/**'
              - 'packages/**'
              - 'package.json'
              - 'bun.lock'
            server:
              - 'apps/server/**'
              - 'packages/**'
              - 'package.json'
              - 'bun.lock'
            e2e:
              - 'apps/web/**'
              - 'packages/**'

  quality:
    name: Quality
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.web == 'true' || needs.changes.outputs.server == 'true' || github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-${{ github.sha }}
          restore-keys: turbo-${{ runner.os }}-

      - run: bun install

      - name: Lint & Format
        run: bunx biome check .

      - name: Type Check
        run: bun check-types

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [changes, quality]
    if: always() && (needs.quality.result == 'success' || needs.quality.result == 'skipped')
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-${{ github.sha }}
          restore-keys: turbo-${{ runner.os }}-

      - name: Cache Vitest
        uses: actions/cache@v4
        with:
          path: |
            apps/web/.vitest-cache
            apps/server/.vitest-cache
          key: vitest-${{ runner.os }}-${{ hashFiles('**/vitest.config.ts') }}
          restore-keys: vitest-${{ runner.os }}-

      - run: bun install

      - name: Run Tests
        run: bun test:coverage

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./apps/web/coverage/coverage-final.json,./apps/server/coverage/coverage-final.json
          fail_ci_if_error: false

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [changes, quality]
    if: always() && needs.changes.outputs.e2e == 'true' && (needs.quality.result == 'success' || needs.quality.result == 'skipped')
    steps:
      - name: Check required secrets
        run: |
          missing=""
          if [ -z "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" ]; then missing="$missing NEXT_PUBLIC_SUPABASE_URL"; fi
          if [ -z "${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" ]; then missing="$missing NEXT_PUBLIC_SUPABASE_ANON_KEY"; fi
          if [ -z "${{ secrets.BETTER_AUTH_SECRET }}" ]; then missing="$missing BETTER_AUTH_SECRET"; fi
          if [ -n "$missing" ]; then
            echo "❌ Missing required secrets:$missing"
            echo "Add these secrets in GitHub Settings → Secrets → Actions"
            exit 1
          fi
          echo "✅ All required secrets are configured"

      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-${{ github.sha }}
          restore-keys: turbo-${{ runner.os }}-

      - name: Cache Playwright
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: playwright-${{ runner.os }}-

      - name: Cache Next.js
        uses: actions/cache@v4
        with:
          path: apps/web/.next/cache
          key: nextjs-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}-${{ hashFiles('apps/web/src/**/*') }}
          restore-keys: |
            nextjs-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}-
            nextjs-${{ runner.os }}-

      - run: bun install

      - name: Install Playwright
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: cd apps/web && bunx playwright install --with-deps chromium

      - name: Install Playwright Deps
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: cd apps/web && bunx playwright install-deps chromium

      - name: Build
        run: cd apps/web && bun run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}

      - name: Run E2E Tests
        run: cd apps/web && bun test:e2e --project=chromium
        env:
          CI: true
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          BETTER_AUTH_DATABASE_URL: ${{ secrets.BETTER_AUTH_DATABASE_URL }}

      - name: Upload Report
        uses: actions/upload-artifact@v6
        if: failure()
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 7

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [changes, unit-tests]
    if: always() && (needs.unit-tests.result == 'success' || needs.unit-tests.result == 'skipped')
    steps:
      - name: Check required secrets
        run: |
          missing=""
          if [ -z "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" ]; then missing="$missing NEXT_PUBLIC_SUPABASE_URL"; fi
          if [ -z "${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" ]; then missing="$missing NEXT_PUBLIC_SUPABASE_ANON_KEY"; fi
          if [ -z "${{ secrets.BETTER_AUTH_SECRET }}" ]; then missing="$missing BETTER_AUTH_SECRET"; fi
          if [ -n "$missing" ]; then
            echo "❌ Missing required secrets:$missing"
            echo "Add these secrets in GitHub Settings → Secrets → Actions"
            exit 1
          fi
          echo "✅ All required secrets are configured"

      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-${{ github.sha }}
          restore-keys: turbo-${{ runner.os }}-

      - name: Cache Next.js
        uses: actions/cache@v4
        with:
          path: apps/web/.next/cache
          key: nextjs-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}-${{ hashFiles('apps/web/src/**/*') }}
          restore-keys: |
            nextjs-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}-
            nextjs-${{ runner.os }}-

      - run: bun install

      - name: Build
        run: bun run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-output
          path: |
            apps/web/.next
            apps/server/dist
          retention-days: 1

  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [quality, unit-tests, e2e-tests, build]
    if: always()
    steps:
      - name: Check Status
        run: |
          if [[ "${{ needs.quality.result }}" == "failure" ]] || \
             [[ "${{ needs.unit-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.e2e-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.build.result }}" == "failure" ]]; then
            echo "❌ CI failed!"
            exit 1
          fi
          echo "✅ CI passed!"
